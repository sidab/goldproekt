<template>

    <div class="page" data-name="building-process">

        <div class="navbar">

            <div class="navbar-inner sliding">

                <div class="title">Ход строительства</div>

            </div>

        </div>

        <div class="page-content">

            <div class="row no-gap">

                {{#each items}}

                    <div class="col-100 tablet-50 item margin-bottom">

                        <a href="#" class="display-block card item-inner elevation-hover-10 elevation-5">

                            <div class="card-header align-items-flex-end text-color-white no-padding">

                                {{#js_if "this.video.length > 0"}}

                                    <div class="overlay"></div>

                                    <img data-index="{{@index}}" data-video="{{ video }}" {{#js_if "this.@index > 5"}}data-{{/js_if}}src="http://img.youtube.com/vi/{{ video }}/0.jpg" class="{{#js_if "this.@index > 5"}}lazy{{/js_if}} save-to-cache" width="100%">

                                    <i class="icon material-icons md-only text-color-orange">play_circle_outline</i>
                                    <i class="icon f7-icons ios-only text-color-orange">play_round</i>

                                {{else}}

                                    <img data-index="{{@index}}" data-image="{{js "app.methods.getFullLink(this.image)" }}" {{#js_if "this.@index > 5"}}data-{{/js_if}}src="{{js "app.methods.getFullLink(this.image)" }}" class="{{#js_if "this.@index > 5"}}lazy{{/js_if}} save-to-cache" width="100%">

                                {{/js_if}}

                            </div>

                            <div class="card-content card-content-padding">

                                <div class="item-title"><b class="block-title block-title-medium no-margin-horizontal">{{ title }}</b></div>

                                <div class="text-color-gray">

                                    <div><i class="icon material-icons md-only">calendar</i><i class="icon f7-icons ios-only">calendar</i><small>{{ created_at }}</small></div>

                                </div>

                            </div>

                        </a>

                    </div>

                {{/each}}

            </div>

        </div>

    </div>

</template>

<style scoped>

    {{this}} .item i {
        font-size: 14px;
        padding-right: 5px;
    }

    {{this}} .item .overlay {
                 position: absolute;
                 z-index: 9;
                background: rgba(0, 0, 0, 0.5);
                 width: 100%;
                 height: 100%;
             }
    {{this}} .item {
                 position: relative;
             }

    {{this}} .item .card-header i {
                 width: 100%;
                 display: block;
                 text-align: center;
                 position: absolute;
                 top: 45%;
                 font-size: 35px;
                 z-index: 99;
             }

</style>

<script>

    return {

        data: function () {

            return {

                items: function () {

                    var component = this;

                    if (localStorage.buildingProcess !== undefined) {

                        var items = JSON.parse(localStorage.buildingProcess);

                    } else {

                        var items = component.loadItems();

                    }

                    return items;

                }

            }

        },
        methods: {
            loadItems: function () {

                var items = false;

                app.request({
                    url: encodeURI(app.params.backend + '/api/building-process'),
                    cache: false,
                    async: false,
                    dataType: 'json',
                    preloader: true,
                    success: function(response) {

                        localStorage.buildingProcess = JSON.stringify(response);

                        items = response;

                    }
                });

                return items;

            }
        },
        on: {

            pageInit: function() {

                var page = this.$el;

                var items = [];

                page.find('img').each(function() {

                    if ($$(this).data('video') !== undefined) {

                        items.push({
                            html: '<iframe src="https://www.youtube.com/embed/'+ $$(this).data('video') +'?modestbranding=1&rel=0&autohide=1&showinfo=0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>',
                        });

                    } else {

                        items.push({
                            url: $$(this).data('image')
                        });

                    }

                });

                var resizeIframe = function (photoBrowser) {

                    var width = $$(photoBrowser.$el).width();
                    var height = +width - (width / 3) +'px';

                    $$(photoBrowser.$el).find('iframe').css('max-height', height);

                };

                var photoBrowser = app.photoBrowser.create({
                    photos: items,
                    theme: 'dark',
                    routableModals: false,
                    type: 'page',
                    lazy: {
                        enabled: false,
                    },
                    swiper: {
                        lazy: false,
                        zoom: {
                            maxRatio: 10
                        }
                    },
                    view: app.views.get('#view-building-process'),
                    on: {
                        open: function() {

                            resizeIframe(this);

                        },
                        slideChange: function() {

                            resizeIframe(this);

                        }
                    }
                });

                page.find('.item').on('click', function() {

                    var index = parseInt($$(this).find('img').data('index'));

                    photoBrowser.open(index);

                });

            }

        }

    }

</script>